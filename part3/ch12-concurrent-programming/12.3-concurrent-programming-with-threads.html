
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>12.3 基于线程的并发编程 · HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.7.1">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="12.4-shared-variables-in-threaded-programs.html" />
    
    
    <link rel="prev" href="12.2-concurrent-programming-with-io-multiplexing.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    本电子书信息
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">出版信息</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../publish-info/publisher-words.html">
            
                <a href="../../publish-info/publisher-words.html">
            
                    
                    出版者的话
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../publish-info/chinese-preface-1.html">
            
                <a href="../../publish-info/chinese-preface-1.html">
            
                    
                    中文版序一
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../publish-info/chinese-preface-2.html">
            
                <a href="../../publish-info/chinese-preface-2.html">
            
                    
                    中文版序二
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../publish-info/translators-preface.html">
            
                <a href="../../publish-info/translators-preface.html">
            
                    
                    译者序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../../publish-info/preface.html">
            
                <a href="../../publish-info/preface.html">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../../publish-info/about-authors.html">
            
                <a href="../../publish-info/about-authors.html">
            
                    
                    关于作者
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../ch01-a-tour-of-computer-systems/">
            
                <a href="../../ch01-a-tour-of-computer-systems/">
            
                    
                    第 1 章：计算机系统漫游
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../../ch01-a-tour-of-computer-systems/1.1.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.1.html">
            
                    
                    1.1 信息就是位 + 上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../ch01-a-tour-of-computer-systems/1.2.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.2.html">
            
                    
                    1.2 程序被其他程序翻译成不同的格式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../ch01-a-tour-of-computer-systems/1.3.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.3.html">
            
                    
                    1.3 了解编译系统如何工作是大有益处的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../ch01-a-tour-of-computer-systems/1.4.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.4.html">
            
                    
                    1.4 处理器读并解释储存在内存中的指令
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../ch01-a-tour-of-computer-systems/1.5.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.5.html">
            
                    
                    1.5 高速缓存至关重要
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../ch01-a-tour-of-computer-systems/1.6.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.6.html">
            
                    
                    1.6 存储设备形成层次结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../ch01-a-tour-of-computer-systems/1.7.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.7.html">
            
                    
                    1.7 操作系统管理硬件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../ch01-a-tour-of-computer-systems/1.8.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.8.html">
            
                    
                    1.8 系统之间利用网络通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../../ch01-a-tour-of-computer-systems/1.9.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.9.html">
            
                    
                    1.9 重要主题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../../ch01-a-tour-of-computer-systems/1.10-xiao-jie.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.10-xiao-jie.html">
            
                    
                    1.10 小结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">第一部分：程序结构和执行</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../../part1/ch02-representing-and-manipulating-information/">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/">
            
                    
                    第 2 章：信息的表示和处理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../../part1/ch02-representing-and-manipulating-information/2.1-xin-xi-cun-chu.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.1-xin-xi-cun-chu.html">
            
                    
                    2.1 信息存储
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../../part1/ch02-representing-and-manipulating-information/2.2-zheng-shu-biao-shi.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.2-zheng-shu-biao-shi.html">
            
                    
                    2.2 整数表示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../../part1/ch02-representing-and-manipulating-information/2.3-zheng-shu-yun-suan.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.3-zheng-shu-yun-suan.html">
            
                    
                    2.3 整数运算
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../../part1/ch02-representing-and-manipulating-information/2.4-fu-dian-shu.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.4-fu-dian-shu.html">
            
                    
                    2.4 浮点数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="../../part1/ch02-representing-and-manipulating-information/2.5-xiao-jie.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.5-xiao-jie.html">
            
                    
                    2.5 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="../../part1/ch02-representing-and-manipulating-information/jia-ting-zuo-ye.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/jia-ting-zuo-ye.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../part1/ch03-machine-level-representing-of-programs/">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/">
            
                    
                    第 3 章：程序的机器级表示
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="../../part1/ch03-machine-level-representing-of-programs/3.1-a-historial-perspective.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.1-a-historial-perspective.html">
            
                    
                    3.1 历史观点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="../../part1/ch03-machine-level-representing-of-programs/3.2-program-encodings.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.2-program-encodings.html">
            
                    
                    3.2 程序编码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="../../part1/ch03-machine-level-representing-of-programs/3.3-data-formats.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.3-data-formats.html">
            
                    
                    3.3 数据格式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="../../part1/ch03-machine-level-representing-of-programs/3.4-accessing-information.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.4-accessing-information.html">
            
                    
                    3.4 访问信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../../part1/ch04-processor-architecture.html">
            
                <a href="../../part1/ch04-processor-architecture.html">
            
                    
                    第 4 章：处理器体系结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../../part1/ch05-optimizing-program-performance.html">
            
                <a href="../../part1/ch05-optimizing-program-performance.html">
            
                    
                    第 5 章：优化程序性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../../part1/ch06-the-memory-hierarchy.html">
            
                <a href="../../part1/ch06-the-memory-hierarchy.html">
            
                    
                    第 6 章：存储器层次结构
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第二部分：在系统上运行程序</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../part2/ch07-linking/">
            
                <a href="../../part2/ch07-linking/">
            
                    
                    第 7 章：链接
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../part2/ch07-linking/7.1-compiler-drviers.html">
            
                <a href="../../part2/ch07-linking/7.1-compiler-drviers.html">
            
                    
                    7.1 编译器驱动程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../part2/ch07-linking/7.2-static-linking.html">
            
                <a href="../../part2/ch07-linking/7.2-static-linking.html">
            
                    
                    7.2 静态链接
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="../../part2/ch07-linking/7.3-object-files.html">
            
                <a href="../../part2/ch07-linking/7.3-object-files.html">
            
                    
                    7.3 目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.4" data-path="../../part2/ch07-linking/7.4-relocatable-object-files.html">
            
                <a href="../../part2/ch07-linking/7.4-relocatable-object-files.html">
            
                    
                    7.4 可重定位目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.5" data-path="../../part2/ch07-linking/7.5-symbols-and-symbol-tables.html">
            
                <a href="../../part2/ch07-linking/7.5-symbols-and-symbol-tables.html">
            
                    
                    7.5 符号和符号表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.6" data-path="../../part2/ch07-linking/7.6-symbol-resolution.html">
            
                <a href="../../part2/ch07-linking/7.6-symbol-resolution.html">
            
                    
                    7.6 符号解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.7" data-path="../../part2/ch07-linking/7.7-relocation.html">
            
                <a href="../../part2/ch07-linking/7.7-relocation.html">
            
                    
                    7.7 重定位
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.8" data-path="../../part2/ch07-linking/7.8-executable-object-files.html">
            
                <a href="../../part2/ch07-linking/7.8-executable-object-files.html">
            
                    
                    7.8 可执行目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.9" data-path="../../part2/ch07-linking/7.9-loading-executable-object-files.html">
            
                <a href="../../part2/ch07-linking/7.9-loading-executable-object-files.html">
            
                    
                    7.9 加载可执行目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.10" data-path="../../part2/ch07-linking/7.10-dynamic-linking-with-shared-libraries.html">
            
                <a href="../../part2/ch07-linking/7.10-dynamic-linking-with-shared-libraries.html">
            
                    
                    7.10 动态链接共享库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.11" data-path="../../part2/ch07-linking/7.11-loading-and-linking-shared-libraries-from-applications.html">
            
                <a href="../../part2/ch07-linking/7.11-loading-and-linking-shared-libraries-from-applications.html">
            
                    
                    7.11 从应用程序中加载和链接共享库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.12" data-path="../../part2/ch07-linking/7.12-position-independent-code.html">
            
                <a href="../../part2/ch07-linking/7.12-position-independent-code.html">
            
                    
                    7.12 位置无关代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.13" data-path="../../part2/ch07-linking/7.13-library-interpositioning.html">
            
                <a href="../../part2/ch07-linking/7.13-library-interpositioning.html">
            
                    
                    7.13 库打桩机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.14" data-path="../../part2/ch07-linking/7.14-tools-for-manipulating-object-files.html">
            
                <a href="../../part2/ch07-linking/7.14-tools-for-manipulating-object-files.html">
            
                    
                    7.14 处理目标文件的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.15" data-path="../../part2/ch07-linking/7.15-summary.html">
            
                <a href="../../part2/ch07-linking/7.15-summary.html">
            
                    
                    7.15 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.16" data-path="../../part2/ch07-linking/homework.html">
            
                <a href="../../part2/ch07-linking/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../../part2/ch08-exceptional-control-flow/">
            
                <a href="../../part2/ch08-exceptional-control-flow/">
            
                    
                    第 8 章：异常控制流
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.2.1" data-path="../../part2/ch08-exceptional-control-flow/8.1-exceptions.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.1-exceptions.html">
            
                    
                    8.1 异常
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.2" data-path="../../part2/ch08-exceptional-control-flow/8.2-processes.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.2-processes.html">
            
                    
                    8.2 进程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.3" data-path="../../part2/ch08-exceptional-control-flow/8.3-system-call-error-handling.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.3-system-call-error-handling.html">
            
                    
                    8.3 系统调用错误处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.4" data-path="../../part2/ch08-exceptional-control-flow/8.4-process-control.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.4-process-control.html">
            
                    
                    8.4 进程控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.5" data-path="../../part2/ch08-exceptional-control-flow/8.5-signals.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.5-signals.html">
            
                    
                    8.5 信号
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.6" data-path="../../part2/ch08-exceptional-control-flow/8.6-nonlocal-jumps.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.6-nonlocal-jumps.html">
            
                    
                    8.6 非本地跳转
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.7" data-path="../../part2/ch08-exceptional-control-flow/8.7-tools-for-manipulating-processes.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.7-tools-for-manipulating-processes.html">
            
                    
                    8.7 操作进程的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.8" data-path="../../part2/ch08-exceptional-control-flow/8.8-summary.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.8-summary.html">
            
                    
                    8.8 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.9" data-path="../../part2/ch08-exceptional-control-flow/homework.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../../part2/ch09-virtual-memory/">
            
                <a href="../../part2/ch09-virtual-memory/">
            
                    
                    第 9 章：虚拟内存
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.3.1" data-path="../../part2/ch09-virtual-memory/9.1-physical-and-virtual-addressing.html">
            
                <a href="../../part2/ch09-virtual-memory/9.1-physical-and-virtual-addressing.html">
            
                    
                    9.1 物理和虚拟寻址
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.2" data-path="../../part2/ch09-virtual-memory/9.2-address-spaces.html">
            
                <a href="../../part2/ch09-virtual-memory/9.2-address-spaces.html">
            
                    
                    9.2 地址空间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.3" data-path="../../part2/ch09-virtual-memory/9.3-vm-as-a-tool-for-caching.html">
            
                <a href="../../part2/ch09-virtual-memory/9.3-vm-as-a-tool-for-caching.html">
            
                    
                    9.3 虚拟内存作为缓存的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.4" data-path="../../part2/ch09-virtual-memory/9.4-vm-as-a-tool-for-memory-management.html">
            
                <a href="../../part2/ch09-virtual-memory/9.4-vm-as-a-tool-for-memory-management.html">
            
                    
                    9.4 虚拟内存作为内存管理的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.5" data-path="../../part2/ch09-virtual-memory/9.5-vm-as-a-tool-for-memory-protection.html">
            
                <a href="../../part2/ch09-virtual-memory/9.5-vm-as-a-tool-for-memory-protection.html">
            
                    
                    9.5 虚拟内存作为内存保护的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.6" data-path="../../part2/ch09-virtual-memory/9.6-address-translation.html">
            
                <a href="../../part2/ch09-virtual-memory/9.6-address-translation.html">
            
                    
                    9.6 地址翻译
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.7" data-path="../../part2/ch09-virtual-memory/9.7-case-study-the-intel-core-i7-linux-memory-system.html">
            
                <a href="../../part2/ch09-virtual-memory/9.7-case-study-the-intel-core-i7-linux-memory-system.html">
            
                    
                    9.7 案例研究：Intel Core i7 / Linux 内存系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.8" data-path="../../part2/ch09-virtual-memory/9.8-memory-mapping.html">
            
                <a href="../../part2/ch09-virtual-memory/9.8-memory-mapping.html">
            
                    
                    9.8 内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.9" data-path="../../part2/ch09-virtual-memory/9.9-dynamic-memory-allocation.html">
            
                <a href="../../part2/ch09-virtual-memory/9.9-dynamic-memory-allocation.html">
            
                    
                    9.9 动态内存分配
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.10" data-path="../../part2/ch09-virtual-memory/9.10-garbage-collection.html">
            
                <a href="../../part2/ch09-virtual-memory/9.10-garbage-collection.html">
            
                    
                    9.10 垃圾收集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.11" data-path="../../part2/ch09-virtual-memory/9.11-common-memoory-related-bugs-in-c-programs.html">
            
                <a href="../../part2/ch09-virtual-memory/9.11-common-memoory-related-bugs-in-c-programs.html">
            
                    
                    9.11 C 程序中常见的与内存有关的错误
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.12" data-path="../../part2/ch09-virtual-memory/9.12-summary.html">
            
                <a href="../../part2/ch09-virtual-memory/9.12-summary.html">
            
                    
                    9.12 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.13" data-path="../../part2/ch09-virtual-memory/homework.html">
            
                <a href="../../part2/ch09-virtual-memory/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">第三部分：程序间的交互和通信</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../ch10-system-level-io/">
            
                <a href="../ch10-system-level-io/">
            
                    
                    第 10 章：系统级 I/O
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1.1" data-path="../ch10-system-level-io/10.1-unix-io.html">
            
                <a href="../ch10-system-level-io/10.1-unix-io.html">
            
                    
                    10.1 Unix I/O
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.2" data-path="../ch10-system-level-io/10.2-files.html">
            
                <a href="../ch10-system-level-io/10.2-files.html">
            
                    
                    10.2 文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.3" data-path="../ch10-system-level-io/10.3-opening-and-closing-files.html">
            
                <a href="../ch10-system-level-io/10.3-opening-and-closing-files.html">
            
                    
                    10.3 打开和关闭文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.4" data-path="../ch10-system-level-io/10.4-reading-and-writing-files.html">
            
                <a href="../ch10-system-level-io/10.4-reading-and-writing-files.html">
            
                    
                    10.4 读和写文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.5" data-path="../ch10-system-level-io/10.5-robust-reading-and-writing-with-the-rio-package.html">
            
                <a href="../ch10-system-level-io/10.5-robust-reading-and-writing-with-the-rio-package.html">
            
                    
                    10.5 用 RIO 包健壮地读写
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.6" data-path="../ch10-system-level-io/10.6-reading-file-metadata.html">
            
                <a href="../ch10-system-level-io/10.6-reading-file-metadata.html">
            
                    
                    10.6 读取文件元数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.7" data-path="../ch10-system-level-io/10.7-reading-directory-contents.html">
            
                <a href="../ch10-system-level-io/10.7-reading-directory-contents.html">
            
                    
                    10.7 读取目录内容
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.8" data-path="../ch10-system-level-io/10.8-sharing-files.html">
            
                <a href="../ch10-system-level-io/10.8-sharing-files.html">
            
                    
                    10.8 共享文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.9" data-path="../ch10-system-level-io/10.9-io-redirection.html">
            
                <a href="../ch10-system-level-io/10.9-io-redirection.html">
            
                    
                    10.9 I/O 重定向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.10" data-path="../ch10-system-level-io/10.10-standard-io.html">
            
                <a href="../ch10-system-level-io/10.10-standard-io.html">
            
                    
                    10.10 标准 I/O
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.11" data-path="../ch10-system-level-io/10.11-putting-it-together-which-io-functions-should-i-use.html">
            
                <a href="../ch10-system-level-io/10.11-putting-it-together-which-io-functions-should-i-use.html">
            
                    
                    10.11 综合：我该使用哪些 I/O 函数？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.12" data-path="../ch10-system-level-io/10.12-summary.html">
            
                <a href="../ch10-system-level-io/10.12-summary.html">
            
                    
                    10.12 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.13" data-path="../ch10-system-level-io/homework.html">
            
                <a href="../ch10-system-level-io/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../ch11-network-programming/">
            
                <a href="../ch11-network-programming/">
            
                    
                    第 11 章：网络编程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.2.1" data-path="../ch11-network-programming/11.1-the-client-server-programming-model.html">
            
                <a href="../ch11-network-programming/11.1-the-client-server-programming-model.html">
            
                    
                    11.1 客户端—服务器编程模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.2" data-path="../ch11-network-programming/11.2-networks.html">
            
                <a href="../ch11-network-programming/11.2-networks.html">
            
                    
                    11.2 网络
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.3" data-path="../ch11-network-programming/11.3-the-global-ip-internet.html">
            
                <a href="../ch11-network-programming/11.3-the-global-ip-internet.html">
            
                    
                    11.3 全球 IP 因特网
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.4" data-path="../ch11-network-programming/11.4-the-sockets-interface.html">
            
                <a href="../ch11-network-programming/11.4-the-sockets-interface.html">
            
                    
                    11.4 套接字接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.5" data-path="../ch11-network-programming/11.5-web-servers.html">
            
                <a href="../ch11-network-programming/11.5-web-servers.html">
            
                    
                    11.5 Web 服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.6" data-path="../ch11-network-programming/11.6-putting-it-together-the-tiny-web-server.html">
            
                <a href="../ch11-network-programming/11.6-putting-it-together-the-tiny-web-server.html">
            
                    
                    11.6 综合：TINY Web 服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.7" data-path="../ch11-network-programming/11.7-summary.html">
            
                <a href="../ch11-network-programming/11.7-summary.html">
            
                    
                    11.7 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.8" data-path="../ch11-network-programming/homework.html">
            
                <a href="../ch11-network-programming/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="./">
            
                <a href="./">
            
                    
                    第 12 章：并发编程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.3.1" data-path="12.1-concurrent-programming-with-processes.html">
            
                <a href="12.1-concurrent-programming-with-processes.html">
            
                    
                    12.1 基于进程的并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.2" data-path="12.2-concurrent-programming-with-io-multiplexing.html">
            
                <a href="12.2-concurrent-programming-with-io-multiplexing.html">
            
                    
                    12.2 基于 I/O 多路复用的并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="6.3.3" data-path="12.3-concurrent-programming-with-threads.html">
            
                <a href="12.3-concurrent-programming-with-threads.html">
            
                    
                    12.3 基于线程的并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.4" data-path="12.4-shared-variables-in-threaded-programs.html">
            
                <a href="12.4-shared-variables-in-threaded-programs.html">
            
                    
                    12.4 多线程程序中的共享变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.5" data-path="12.5-synchronizing-thread-with-semaphores.html">
            
                <a href="12.5-synchronizing-thread-with-semaphores.html">
            
                    
                    12.5 用信号量同步线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.6" data-path="12.6-using-threads-for-parallelism.html">
            
                <a href="12.6-using-threads-for-parallelism.html">
            
                    
                    12.6 使用线程提高并行性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.7" data-path="12.7-other-concurrency-issues.html">
            
                <a href="12.7-other-concurrency-issues.html">
            
                    
                    12.7 其他并发问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.8" data-path="12.8-summary.html">
            
                <a href="12.8-summary.html">
            
                    
                    12.8 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.9" data-path="homework.html">
            
                <a href="homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../../appendix-error-handling.html">
            
                <a href="../../appendix-error-handling.html">
            
                    
                    附录 A：错误处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="../../references.html">
            
                <a href="../../references.html">
            
                    
                    参考文献
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">实验</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="../../labs/labs-overview/">
            
                <a href="../../labs/labs-overview/">
            
                    
                    实验总览
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1.1" data-path="../../labs/labs-overview/common-problems.html">
            
                <a href="../../labs/labs-overview/common-problems.html">
            
                    
                    常见问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="../../labs/data-lab/">
            
                <a href="../../labs/data-lab/">
            
                    
                    实验 1：Data Lab
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.2.1" data-path="../../labs/data-lab/readme-instructor.html">
            
                <a href="../../labs/data-lab/readme-instructor.html">
            
                    
                    README（讲师版）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2.2" data-path="../../labs/data-lab/readme-student.html">
            
                <a href="../../labs/data-lab/readme-student.html">
            
                    
                    README（学生版）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2.3" data-path="../../labs/data-lab/writeup.html">
            
                <a href="../../labs/data-lab/writeup.html">
            
                    
                    Writeup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.3" data-path="../../labs/bomb-lab/">
            
                <a href="../../labs/bomb-lab/">
            
                    
                    实验 2：Bomb Lab
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.3.1" data-path="../../labs/bomb-lab/readme-jiang-shi-ban.html">
            
                <a href="../../labs/bomb-lab/readme-jiang-shi-ban.html">
            
                    
                    README（讲师版）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.3.2" data-path="../../labs/bomb-lab/writeup.html">
            
                <a href="../../labs/bomb-lab/writeup.html">
            
                    
                    Writeup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.4" data-path="../../labs/attack-lab.html">
            
                <a href="../../labs/attack-lab.html">
            
                    
                    实验 3：Attack Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.5" data-path="../../labs/arch-lab.html">
            
                <a href="../../labs/arch-lab.html">
            
                    
                    实验 4：Architechture Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.6" data-path="../../labs/cache-lab.html">
            
                <a href="../../labs/cache-lab.html">
            
                    
                    实验 5：Cache Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.7" data-path="../../labs/perf-lab.html">
            
                <a href="../../labs/perf-lab.html">
            
                    
                    实验 6：Performance Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.8" data-path="../../labs/shell-lab.html">
            
                <a href="../../labs/shell-lab.html">
            
                    
                    实验 7：Shell Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.9" data-path="../../labs/malloc-lab.html">
            
                <a href="../../labs/malloc-lab.html">
            
                    
                    实验 8：Malloc Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.10" data-path="../../labs/proxy-lab.html">
            
                <a href="../../labs/proxy-lab.html">
            
                    
                    实验 9：Proxy Lab
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >12.3 基于线程的并发编程</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="123-基于线程的并发编程">12.3 基于线程的并发编程</h1>
<p>到目前为止，我们已经看到了两种创建并发逻辑流的方法。在第一种方法中，我们为每个流使用了单独的进程。内核会自动调度每个进程. 而每个进程有它自己的私有地址空间，这使得流共享数据很困难。在第二种方法中，我们创建自己的逻辑流，并利用 I/O 多路复用来显式地调度流。因为只有一个进程，所有的流共享整个地址空间。本节介绍第三种方法——基于线程，它是这两种方法的混合。</p>
<p><strong>线程</strong>（thread）就是运行在进程上下文中的逻辑流。在本书里迄今为止，程序都是由每个进程中一个线程组成的。但是现代系统也允许我们编写一个进程里同时运行多个线程的程序。线程由内核自动调度。每个线程都有它自己的<strong>线程上下文</strong>（thread context），包括一个唯一的整数<strong>线程 ID</strong>（Thread ID，TID）、栈、栈指针、程序计数器、通用目的寄存器和条件码。所有的运行在一个进程里的线程共享该进程的整个虚拟地址空间。</p>
<p>基于线程的逻辑流结合了基于进程和基于 I/O 多路复用的流的特性。同进程一样，线程由内核自动调度，并且内核通过一个整数 ID 来识别线程。同基于 I/O 多路复用的流一样，多个线程运行在单一进程的上下文中，因此共享这个进程虚拟地址空间的所有内容，包括它的代码、数据、堆、共享库和打开的文件。</p>
<h2 id="1231-线程执行模型">12.3.1 线程执行模型</h2>
<p>多线程的执行模型在某些方面和多进程的执行模型是相似的。思考图 12-12 中的示例。每个进程开始生命周期时都是单一线程，这个线程称为<strong>主线程</strong>（main thread）。在某一时刻，主线程创建一个<strong>对等线程</strong>（peer thread），从这个时间点开始，两个线程就并发地运行。最后，因为主线程执行一个慢速系统调用，例如 read 或者 sleep，或者因为被系统的间隔计时器中断，控制就会通过上下文切换传递到对等线程。对等线程会执行一段时间，然后控制传递回主线程，依次类推。</p>
<p><img src="../../.gitbook/assets/1212-bing-fa-xian-cheng-zhi-hang-.png" alt="图 12-12 并发线程执行"></p>
<p>在一些重要的方面，线程执行是不同于进程的。因为一个线程的上下文要比一个进程的上下文小得多，线程的上下文切换要比进程的上下文切换快得多。另一个不同就是线程不像进程那样，不是按照严格的父子层次来组织的。和一个进程相关的线程组成一个对等（线程）池，独立于其他线程创建的线程。主线程和其他线程的区别仅在于它总是进程中第一个运行的线程。对等（线程）池概念的主要影响是，一个线程可以杀死它的任何对等线程，或者等待它的任意对等线程终止。另外，每个对等线程都能读写相同的共享数据。</p>
<h2 id="1232-posix-线程">12.3.2 Posix 线程</h2>
<p>Posix 线程（Pthreads）是在 C 程序中处理线程的一个标准接口。它最早出现在 1995 年，而且在所有的 Linux 系统上都可用。Pthreads 定义了大约 60 个函数，允许程序创建、杀死和回收线程，与对等线程安全地共享数据，还可以通知对等线程系统状态的变化。</p>
<p>图 12-13 展示了一个简单的 Pthreads 程序。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;csapp.h&quot;</span></span>
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *vargp)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">pthread_t</span> tid;
    Pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thread, <span class="hljs-literal">NULL</span>);
    Pthread_join(tid, <span class="hljs-literal">NULL</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *vargp)</span> <span class="hljs-comment">/* Thread routine */</span>
</span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello, world!\n&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<blockquote>
<p>图 12-13 hello.c：使用 Pthreads 的 “Hello, world!” 程序</p>
</blockquote>
<p>主线程创建一个对等线程，然后等待它的终止。对等线程输岀 “Hello, world!\n” 并且终止。当主线程检测到对等线程终止后，它就通过调用 exit 终止该进程。这是我们看到的第一个线程化的程序，所以让我们仔细地解析它。线程的代码和本地数据被封装在一个<strong>线程例程</strong>（thread routine）中。正如第二行里的原型所示，每个线程例程都以一个通用指针作为输入，并返回一个通用指针。如果想传递多个参数给线程例程，那么你应该将参数放到一个结构中，并传递一个指向该结构的指针。相似地，如果想要线程例程返回多个参数，你可以返回一个指向一个结构的指针。</p>
<p>第 4 行标出了主线程代码的开始。主线程声明了一个本地变量 tid，可以用来存放对等线程的 ID（第 6 行）。主线程通过调用 pthread_create 函数创建一个新的对等线程（第 7 行）。当对 pthread_create 的调用返回时，主线程和新创建的对等线程同时运行，并且 tid 包含新线程的 ID。通过在第 8 行调用 pthread_join，主线程等待对等线程终止。最后，主线程调用 exit（第 9 行），终止当时运行在这个进程中的所有线程（在这个示例中就只有主线程）。</p>
<p>第 12 ~ 16 行定义了对等线程的例程。它只打印一个字符串，然后就通过执行第 15 行中的 return 语句来终止对等线程。</p>
<h2 id="1233-创建线程">12.3.3 创建线程</h2>
<p>线程通过调用 pthread_create 函数来创建其他线程。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">void</span> *(func)(<span class="hljs-keyword">void</span> *);

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_create</span><span class="hljs-params">(<span class="hljs-keyword">pthread_t</span> *tid, <span class="hljs-keyword">pthread_attr_t</span> *attr,
                   func *f, <span class="hljs-keyword">void</span> *arg)</span></span>;

<span class="hljs-comment">// 若成功则返回 0，若出错则为非零。</span>
</code></pre>
<p>pthread_create 函数创建一个新的线程，并带着一个输入变量 arg，在新线程的上下文中运行线程例程 f。能用 attr 参数来改变新创建线程的默认属性。改变这些属性已超出我们学习的范围，在我们的示例中，总是用一个为 NULL 的参数来调用 pthread_create 函数。</p>
<p>当 pthread_create 返回时，参数 tid 包含新创建线程的 ID。新线程可以通过调用 pthread_self 函数来获得它自己的线程 ID。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">pthread_t</span> <span class="hljs-title">pthread_self</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span>;

<span class="hljs-comment">// 返回调用者的线程 ID。</span>
</code></pre>
<h2 id="1234-终止线程">12.3.4 终止线程</h2>
<p>一个线程是以下列方式之一来终止的：</p>
<ul>
<li>当顶层的线程例程返回时，线程会<strong>隐式地</strong>终止。</li>
<li>通过调用 pthread_exit 函数，线程会<strong>显式地</strong>终止。如果主线程调用 pthread_exit，它会等待所有其他对等线程终止，然后再终止主线程和整个进程，返回值为 thread_return。</li>
</ul>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pthread_exit</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *thread_return)</span></span>;

<span class="hljs-comment">// 从不返回。</span>
</code></pre>
<ul>
<li>某个对等线程调用 Linux 的 exit 函数，该函数终止进程以及所有与该进程相关的线程。</li>
<li>另一个对等线程通过以当前线程 ID 作为参数调用 pthread_Cancel 函数来终止当前线程。</li>
</ul>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_cancel</span><span class="hljs-params">(<span class="hljs-keyword">pthread_t</span> tid)</span></span>;

<span class="hljs-comment">// 若成功则返回 0，若出错则为非零。</span>
</code></pre>
<h2 id="1235-回收已终止线程的资源">12.3.5 回收已终止线程的资源</h2>
<p>线程通过调用 pthread_join 函数等待其他线程终止。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_join</span><span class="hljs-params">(<span class="hljs-keyword">pthread_t</span> tid, <span class="hljs-keyword">void</span> **thread_return)</span></span>;

<span class="hljs-comment">// 若成功则返回 0，若出错则为非零。</span>
</code></pre>
<p>pthread_join 函数会阻塞，直到线程 tid 终止，将线程例程返回的通用 <strong>(void*)</strong> 指针赋值为 thread_return 指向的位置，然后回收已终止线程占用的所有内存资源。</p>
<p>注意，和 Linux 的 wait 函数不同，pthread_join 函数只能等待一个指定的线程终止。没有办法让 pthread_wait 等待任意一个线程终止。这使得代码更加复杂，因为它迫使我们去使用其他一些不那么直观的机制来检测进程的终止。实际上，Stevens 在【110】中就很有说服力地论证了这是规范中的一个错误。</p>
<h2 id="1236-分离线程">12.3.6 分离线程</h2>
<p>在任何一个时间点上，线程是<strong>可结合的</strong>（joinable）或者是<strong>分离的</strong>（detached）。一个可结合的线程能够被其他线程收回和杀死。在被其他线程回收之前，它的内存资源（例如栈）是不释放的。相反，一个分离的线程是不能被其他线程回收或杀死的。它的内存资源在它终止时由系统自动释放。</p>
<p>默认情况下，线程被创建成可结合的。为了避免内存泄漏，每个可结合线程都应该要么被其他线程显式地收回，要么通过调用 pthread_detach 函数被分离。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_detach</span><span class="hljs-params">(<span class="hljs-keyword">pthread_t</span> tid)</span></span>;

<span class="hljs-comment">// 若成功则返回 0，若出错则为非零。</span>
</code></pre>
<p>pthread_detach 函数分离可结合线程 tid。线程能够通过以 pthread_self() 参数的 pthread_detach 调用来分离它们自己。</p>
<p>尽管我们的一些例子会使用可结合线程，但是在现实程序中，有很好的理由要使用分离的线程。例如，一个高性能 Web 服务器可能在每次收到 Web 浏览器的连接请求时都创建一个新的对等线程。因为每个连接都是由一个单独的线程独立处理的，所以对于服务器而言，就很没有必要（实际上也不愿意）显式地等待每个对等线程终止。在这种情况下，每个对等线程都应该在它开始处理请求之前分离它自身，这样就能在它终止后回收它的内存资源了。</p>
<h2 id="1237-初始化线程">12.3.7 初始化线程</h2>
<p>pthread_once 函数允许你初始化与线程例程相关的状态。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-keyword">pthread_once_t</span> once_control = PTHREAD_ONCE_INIT;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_once</span><span class="hljs-params">(<span class="hljs-keyword">pthread_once_t</span> *once_control,
                 <span class="hljs-keyword">void</span> (*init_routine)(<span class="hljs-keyword">void</span>))</span></span>;

<span class="hljs-comment">// 总是返回 0。</span>
</code></pre>
<p>once_control 变量是一个全局或者静态变量，总是被初始化为 PTHREAD_ONCE_INIT。当你第一次用参数 once_control 调用 pthread_once 时，它调用 init_routine，这是一个没有输入参数、也不返回什么的函数。接下来的以 once_control 为参数的 pthread_once 调用不做任何事情。无论何时，当你需要动态初始化多个线程共享的全局变量时，pthread_once 函数是很有用的。我们将在 12.5.5 节里看到一个示例。</p>
<h2 id="1238-基于线程的并发服务器">12.3.8 基于线程的并发服务器</h2>
<p>图 12-14 展示了基于线程的并发 echo 服务器的代码。</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;csapp.h&quot;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">echo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> connfd)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *vargp)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-keyword">int</span> listenfd, *connfdp;
    <span class="hljs-keyword">socklen_t</span> clientlen;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">clientaddr</span>;</span>
    <span class="hljs-keyword">pthread_t</span> tid;

    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: %s &lt;port&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
    }
    listenfd = Open_listenfd(argv[<span class="hljs-number">1</span>]);

    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        clientlen = <span class="hljs-keyword">sizeof</span>(struct sockaddr_storage);
        connfdp = Malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
        *connfdp = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);
        Pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thread, connfdp);
    }
}

<span class="hljs-comment">/* Thread routine */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *vargp)</span>
</span>{
    <span class="hljs-keyword">int</span> connfd = *((<span class="hljs-keyword">int</span> *)vargp);
    Pthread_detach(pthread_self());
    Free(vargp);
    echo(connfd);
    Close(connfd);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<blockquote>
<p>图 12-14 基于线程的并发 echo 服务器</p>
</blockquote>
<p>整体结构类似于基于进程的设计。主线程不断地等待连接请求，然后创建一个对等线程处理该请求。虽然代码看似简单，但是有几个普遍而且有些微妙的问题需要我们更仔细地看一看。第一个问题是当我们调用 pthread_create 时，如何将已连接描述符传递给对等线程。最明显的方法就是传递一个指向这个描述符的指针，就像下面这样</p>
<pre><code class="lang-c">connfd = Accept(listenfd, (SA *) &amp;clientaddr, &amp;clientlen);
Pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thread, &amp;connfd);
</code></pre>
<p>然后，我们让对等线程间接引用这个指针，并将它赋值给一个局部变量，如下所示</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *vargp)</span> </span>{
    <span class="hljs-keyword">int</span> connfd = *((<span class="hljs-keyword">int</span> *)vargp);
    .
    .
    .
}
</code></pre>
<p>然而，这样可能会出错，因为它在对等线程的赋值语句和主线程的 accept 语句间引入了<strong>竞争</strong>（race）。如果赋值语句在下一个 accept 之前完成，那么对等线程中的局部变量 connfd 就得到正确的描述符值。然而，如果赋值语句是在 accept 之后才完成的，那么对等线程中的局部变量 connfd 就得到下一次连接的描述符值。那么不幸的结果就是，现在两个线程在同一个描述符上执行输入和输出。为了避免这种潜在的致命竞争，我们必须将 accept 返回的每个已连接描述符分配到它自己的动态分配的内存块，如第 20 ~ 21 行所示。我们会在 12.7.4 节中回过来讨论竞争的问题。</p>
<p>另一个问题是在线程例程中避免内存泄漏。既然不显式地收回线程，就必须分离每个线程，使得在它终止时它的内存资源能够被收回（第 31 行）。更进一步，我们必须小心释放主线程分配的内存块（第 32 行）。</p>
<h3 id="练习题-125">练习题 12.5</h3>
<p>在图 12-5 中基于进程的服务器中，我们在两个位置小心地关闭了已连接描述符：父进程和子进程。然而，在图 12-14 中基于线程的服务器中，我们只在一个位置关闭了已连接描述符：对等线程。为什么？</p>
<p>因为线程运行在同一个进程中，它们都共享相同的描述符表。无论有多少线程使用这个已连接描述符，这个已连接描述符的文件表的引用计数都等于 1。因此，当我们用完它时，一个 close 操作就足以释放与这个已连接描述符相关的内存资源了。</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="12.2-concurrent-programming-with-io-multiplexing.html" class="navigation navigation-prev " aria-label="Previous page: 12.2 基于 I/O 多路复用的并发编程">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="12.4-shared-variables-in-threaded-programs.html" class="navigation navigation-next " aria-label="Next page: 12.4 多线程程序中的共享变量">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"12.3 基于线程的并发编程","level":"6.3.3","depth":2,"next":{"title":"12.4 多线程程序中的共享变量","level":"6.3.4","depth":2,"path":"part3/ch12-concurrent-programming/12.4-shared-variables-in-threaded-programs.md","ref":"part3/ch12-concurrent-programming/12.4-shared-variables-in-threaded-programs.md","articles":[]},"previous":{"title":"12.2 基于 I/O 多路复用的并发编程","level":"6.3.2","depth":2,"path":"part3/ch12-concurrent-programming/12.2-concurrent-programming-with-io-multiplexing.md","ref":"part3/ch12-concurrent-programming/12.2-concurrent-programming-with-io-multiplexing.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["hints","page-ref","mathjax-pro"],"pluginsConfig":{"hints":{"info":"fa fa-info-circle","tip":"fa fa-mortar-board","danger":"fa fa-exclamation-circle","working":"fa fa-wrench"},"page-ref":{},"mathjax-pro":{"forceSVG":false,"version":"2.7.7"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"part3/ch12-concurrent-programming/12.3-concurrent-programming-with-threads.md","mtime":"2022-04-29T14:04:53.402Z","type":"markdown"},"gitbook":{"version":"3.7.1","time":"2022-04-30T05:14:56.515Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-mathjax-pro/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

