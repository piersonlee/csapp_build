
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>11.6 综合：TINY Web 服务器 · HonKit</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.7.1">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="11.7-summary.html" />
    
    
    <link rel="prev" href="11.5-web-servers.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    本电子书信息
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">出版信息</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../publish-info/publisher-words.html">
            
                <a href="../../publish-info/publisher-words.html">
            
                    
                    出版者的话
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../../publish-info/chinese-preface-1.html">
            
                <a href="../../publish-info/chinese-preface-1.html">
            
                    
                    中文版序一
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../publish-info/chinese-preface-2.html">
            
                <a href="../../publish-info/chinese-preface-2.html">
            
                    
                    中文版序二
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="../../publish-info/translators-preface.html">
            
                <a href="../../publish-info/translators-preface.html">
            
                    
                    译者序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="../../publish-info/preface.html">
            
                <a href="../../publish-info/preface.html">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="../../publish-info/about-authors.html">
            
                <a href="../../publish-info/about-authors.html">
            
                    
                    关于作者
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../ch01-a-tour-of-computer-systems/">
            
                <a href="../../ch01-a-tour-of-computer-systems/">
            
                    
                    第 1 章：计算机系统漫游
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../../ch01-a-tour-of-computer-systems/1.1.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.1.html">
            
                    
                    1.1 信息就是位 + 上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../ch01-a-tour-of-computer-systems/1.2.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.2.html">
            
                    
                    1.2 程序被其他程序翻译成不同的格式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../ch01-a-tour-of-computer-systems/1.3.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.3.html">
            
                    
                    1.3 了解编译系统如何工作是大有益处的
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="../../ch01-a-tour-of-computer-systems/1.4.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.4.html">
            
                    
                    1.4 处理器读并解释储存在内存中的指令
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="../../ch01-a-tour-of-computer-systems/1.5.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.5.html">
            
                    
                    1.5 高速缓存至关重要
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="../../ch01-a-tour-of-computer-systems/1.6.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.6.html">
            
                    
                    1.6 存储设备形成层次结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="../../ch01-a-tour-of-computer-systems/1.7.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.7.html">
            
                    
                    1.7 操作系统管理硬件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="../../ch01-a-tour-of-computer-systems/1.8.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.8.html">
            
                    
                    1.8 系统之间利用网络通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="../../ch01-a-tour-of-computer-systems/1.9.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.9.html">
            
                    
                    1.9 重要主题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="../../ch01-a-tour-of-computer-systems/1.10-xiao-jie.html">
            
                <a href="../../ch01-a-tour-of-computer-systems/1.10-xiao-jie.html">
            
                    
                    1.10 小结
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">第一部分：程序结构和执行</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../../part1/ch02-representing-and-manipulating-information/">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/">
            
                    
                    第 2 章：信息的表示和处理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="../../part1/ch02-representing-and-manipulating-information/2.1-xin-xi-cun-chu.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.1-xin-xi-cun-chu.html">
            
                    
                    2.1 信息存储
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="../../part1/ch02-representing-and-manipulating-information/2.2-zheng-shu-biao-shi.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.2-zheng-shu-biao-shi.html">
            
                    
                    2.2 整数表示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="../../part1/ch02-representing-and-manipulating-information/2.3-zheng-shu-yun-suan.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.3-zheng-shu-yun-suan.html">
            
                    
                    2.3 整数运算
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="../../part1/ch02-representing-and-manipulating-information/2.4-fu-dian-shu.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.4-fu-dian-shu.html">
            
                    
                    2.4 浮点数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="../../part1/ch02-representing-and-manipulating-information/2.5-xiao-jie.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/2.5-xiao-jie.html">
            
                    
                    2.5 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="../../part1/ch02-representing-and-manipulating-information/jia-ting-zuo-ye.html">
            
                <a href="../../part1/ch02-representing-and-manipulating-information/jia-ting-zuo-ye.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../part1/ch03-machine-level-representing-of-programs/">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/">
            
                    
                    第 3 章：程序的机器级表示
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="../../part1/ch03-machine-level-representing-of-programs/3.1-a-historial-perspective.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.1-a-historial-perspective.html">
            
                    
                    3.1 历史观点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="../../part1/ch03-machine-level-representing-of-programs/3.2-program-encodings.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.2-program-encodings.html">
            
                    
                    3.2 程序编码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="../../part1/ch03-machine-level-representing-of-programs/3.3-data-formats.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.3-data-formats.html">
            
                    
                    3.3 数据格式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="../../part1/ch03-machine-level-representing-of-programs/3.4-accessing-information.html">
            
                <a href="../../part1/ch03-machine-level-representing-of-programs/3.4-accessing-information.html">
            
                    
                    3.4 访问信息
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../../part1/ch04-processor-architecture.html">
            
                <a href="../../part1/ch04-processor-architecture.html">
            
                    
                    第 4 章：处理器体系结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="../../part1/ch05-optimizing-program-performance.html">
            
                <a href="../../part1/ch05-optimizing-program-performance.html">
            
                    
                    第 5 章：优化程序性能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="../../part1/ch06-the-memory-hierarchy.html">
            
                <a href="../../part1/ch06-the-memory-hierarchy.html">
            
                    
                    第 6 章：存储器层次结构
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第二部分：在系统上运行程序</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../part2/ch07-linking/">
            
                <a href="../../part2/ch07-linking/">
            
                    
                    第 7 章：链接
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="../../part2/ch07-linking/7.1-compiler-drviers.html">
            
                <a href="../../part2/ch07-linking/7.1-compiler-drviers.html">
            
                    
                    7.1 编译器驱动程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="../../part2/ch07-linking/7.2-static-linking.html">
            
                <a href="../../part2/ch07-linking/7.2-static-linking.html">
            
                    
                    7.2 静态链接
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="../../part2/ch07-linking/7.3-object-files.html">
            
                <a href="../../part2/ch07-linking/7.3-object-files.html">
            
                    
                    7.3 目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.4" data-path="../../part2/ch07-linking/7.4-relocatable-object-files.html">
            
                <a href="../../part2/ch07-linking/7.4-relocatable-object-files.html">
            
                    
                    7.4 可重定位目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.5" data-path="../../part2/ch07-linking/7.5-symbols-and-symbol-tables.html">
            
                <a href="../../part2/ch07-linking/7.5-symbols-and-symbol-tables.html">
            
                    
                    7.5 符号和符号表
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.6" data-path="../../part2/ch07-linking/7.6-symbol-resolution.html">
            
                <a href="../../part2/ch07-linking/7.6-symbol-resolution.html">
            
                    
                    7.6 符号解析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.7" data-path="../../part2/ch07-linking/7.7-relocation.html">
            
                <a href="../../part2/ch07-linking/7.7-relocation.html">
            
                    
                    7.7 重定位
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.8" data-path="../../part2/ch07-linking/7.8-executable-object-files.html">
            
                <a href="../../part2/ch07-linking/7.8-executable-object-files.html">
            
                    
                    7.8 可执行目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.9" data-path="../../part2/ch07-linking/7.9-loading-executable-object-files.html">
            
                <a href="../../part2/ch07-linking/7.9-loading-executable-object-files.html">
            
                    
                    7.9 加载可执行目标文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.10" data-path="../../part2/ch07-linking/7.10-dynamic-linking-with-shared-libraries.html">
            
                <a href="../../part2/ch07-linking/7.10-dynamic-linking-with-shared-libraries.html">
            
                    
                    7.10 动态链接共享库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.11" data-path="../../part2/ch07-linking/7.11-loading-and-linking-shared-libraries-from-applications.html">
            
                <a href="../../part2/ch07-linking/7.11-loading-and-linking-shared-libraries-from-applications.html">
            
                    
                    7.11 从应用程序中加载和链接共享库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.12" data-path="../../part2/ch07-linking/7.12-position-independent-code.html">
            
                <a href="../../part2/ch07-linking/7.12-position-independent-code.html">
            
                    
                    7.12 位置无关代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.13" data-path="../../part2/ch07-linking/7.13-library-interpositioning.html">
            
                <a href="../../part2/ch07-linking/7.13-library-interpositioning.html">
            
                    
                    7.13 库打桩机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.14" data-path="../../part2/ch07-linking/7.14-tools-for-manipulating-object-files.html">
            
                <a href="../../part2/ch07-linking/7.14-tools-for-manipulating-object-files.html">
            
                    
                    7.14 处理目标文件的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.15" data-path="../../part2/ch07-linking/7.15-summary.html">
            
                <a href="../../part2/ch07-linking/7.15-summary.html">
            
                    
                    7.15 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.16" data-path="../../part2/ch07-linking/homework.html">
            
                <a href="../../part2/ch07-linking/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="../../part2/ch08-exceptional-control-flow/">
            
                <a href="../../part2/ch08-exceptional-control-flow/">
            
                    
                    第 8 章：异常控制流
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.2.1" data-path="../../part2/ch08-exceptional-control-flow/8.1-exceptions.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.1-exceptions.html">
            
                    
                    8.1 异常
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.2" data-path="../../part2/ch08-exceptional-control-flow/8.2-processes.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.2-processes.html">
            
                    
                    8.2 进程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.3" data-path="../../part2/ch08-exceptional-control-flow/8.3-system-call-error-handling.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.3-system-call-error-handling.html">
            
                    
                    8.3 系统调用错误处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.4" data-path="../../part2/ch08-exceptional-control-flow/8.4-process-control.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.4-process-control.html">
            
                    
                    8.4 进程控制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.5" data-path="../../part2/ch08-exceptional-control-flow/8.5-signals.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.5-signals.html">
            
                    
                    8.5 信号
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.6" data-path="../../part2/ch08-exceptional-control-flow/8.6-nonlocal-jumps.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.6-nonlocal-jumps.html">
            
                    
                    8.6 非本地跳转
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.7" data-path="../../part2/ch08-exceptional-control-flow/8.7-tools-for-manipulating-processes.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.7-tools-for-manipulating-processes.html">
            
                    
                    8.7 操作进程的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.8" data-path="../../part2/ch08-exceptional-control-flow/8.8-summary.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/8.8-summary.html">
            
                    
                    8.8 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2.9" data-path="../../part2/ch08-exceptional-control-flow/homework.html">
            
                <a href="../../part2/ch08-exceptional-control-flow/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="../../part2/ch09-virtual-memory/">
            
                <a href="../../part2/ch09-virtual-memory/">
            
                    
                    第 9 章：虚拟内存
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.3.1" data-path="../../part2/ch09-virtual-memory/9.1-physical-and-virtual-addressing.html">
            
                <a href="../../part2/ch09-virtual-memory/9.1-physical-and-virtual-addressing.html">
            
                    
                    9.1 物理和虚拟寻址
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.2" data-path="../../part2/ch09-virtual-memory/9.2-address-spaces.html">
            
                <a href="../../part2/ch09-virtual-memory/9.2-address-spaces.html">
            
                    
                    9.2 地址空间
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.3" data-path="../../part2/ch09-virtual-memory/9.3-vm-as-a-tool-for-caching.html">
            
                <a href="../../part2/ch09-virtual-memory/9.3-vm-as-a-tool-for-caching.html">
            
                    
                    9.3 虚拟内存作为缓存的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.4" data-path="../../part2/ch09-virtual-memory/9.4-vm-as-a-tool-for-memory-management.html">
            
                <a href="../../part2/ch09-virtual-memory/9.4-vm-as-a-tool-for-memory-management.html">
            
                    
                    9.4 虚拟内存作为内存管理的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.5" data-path="../../part2/ch09-virtual-memory/9.5-vm-as-a-tool-for-memory-protection.html">
            
                <a href="../../part2/ch09-virtual-memory/9.5-vm-as-a-tool-for-memory-protection.html">
            
                    
                    9.5 虚拟内存作为内存保护的工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.6" data-path="../../part2/ch09-virtual-memory/9.6-address-translation.html">
            
                <a href="../../part2/ch09-virtual-memory/9.6-address-translation.html">
            
                    
                    9.6 地址翻译
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.7" data-path="../../part2/ch09-virtual-memory/9.7-case-study-the-intel-core-i7-linux-memory-system.html">
            
                <a href="../../part2/ch09-virtual-memory/9.7-case-study-the-intel-core-i7-linux-memory-system.html">
            
                    
                    9.7 案例研究：Intel Core i7 / Linux 内存系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.8" data-path="../../part2/ch09-virtual-memory/9.8-memory-mapping.html">
            
                <a href="../../part2/ch09-virtual-memory/9.8-memory-mapping.html">
            
                    
                    9.8 内存映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.9" data-path="../../part2/ch09-virtual-memory/9.9-dynamic-memory-allocation.html">
            
                <a href="../../part2/ch09-virtual-memory/9.9-dynamic-memory-allocation.html">
            
                    
                    9.9 动态内存分配
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.10" data-path="../../part2/ch09-virtual-memory/9.10-garbage-collection.html">
            
                <a href="../../part2/ch09-virtual-memory/9.10-garbage-collection.html">
            
                    
                    9.10 垃圾收集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.11" data-path="../../part2/ch09-virtual-memory/9.11-common-memoory-related-bugs-in-c-programs.html">
            
                <a href="../../part2/ch09-virtual-memory/9.11-common-memoory-related-bugs-in-c-programs.html">
            
                    
                    9.11 C 程序中常见的与内存有关的错误
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.12" data-path="../../part2/ch09-virtual-memory/9.12-summary.html">
            
                <a href="../../part2/ch09-virtual-memory/9.12-summary.html">
            
                    
                    9.12 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3.13" data-path="../../part2/ch09-virtual-memory/homework.html">
            
                <a href="../../part2/ch09-virtual-memory/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">第三部分：程序间的交互和通信</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../ch10-system-level-io/">
            
                <a href="../ch10-system-level-io/">
            
                    
                    第 10 章：系统级 I/O
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.1.1" data-path="../ch10-system-level-io/10.1-unix-io.html">
            
                <a href="../ch10-system-level-io/10.1-unix-io.html">
            
                    
                    10.1 Unix I/O
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.2" data-path="../ch10-system-level-io/10.2-files.html">
            
                <a href="../ch10-system-level-io/10.2-files.html">
            
                    
                    10.2 文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.3" data-path="../ch10-system-level-io/10.3-opening-and-closing-files.html">
            
                <a href="../ch10-system-level-io/10.3-opening-and-closing-files.html">
            
                    
                    10.3 打开和关闭文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.4" data-path="../ch10-system-level-io/10.4-reading-and-writing-files.html">
            
                <a href="../ch10-system-level-io/10.4-reading-and-writing-files.html">
            
                    
                    10.4 读和写文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.5" data-path="../ch10-system-level-io/10.5-robust-reading-and-writing-with-the-rio-package.html">
            
                <a href="../ch10-system-level-io/10.5-robust-reading-and-writing-with-the-rio-package.html">
            
                    
                    10.5 用 RIO 包健壮地读写
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.6" data-path="../ch10-system-level-io/10.6-reading-file-metadata.html">
            
                <a href="../ch10-system-level-io/10.6-reading-file-metadata.html">
            
                    
                    10.6 读取文件元数据
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.7" data-path="../ch10-system-level-io/10.7-reading-directory-contents.html">
            
                <a href="../ch10-system-level-io/10.7-reading-directory-contents.html">
            
                    
                    10.7 读取目录内容
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.8" data-path="../ch10-system-level-io/10.8-sharing-files.html">
            
                <a href="../ch10-system-level-io/10.8-sharing-files.html">
            
                    
                    10.8 共享文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.9" data-path="../ch10-system-level-io/10.9-io-redirection.html">
            
                <a href="../ch10-system-level-io/10.9-io-redirection.html">
            
                    
                    10.9 I/O 重定向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.10" data-path="../ch10-system-level-io/10.10-standard-io.html">
            
                <a href="../ch10-system-level-io/10.10-standard-io.html">
            
                    
                    10.10 标准 I/O
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.11" data-path="../ch10-system-level-io/10.11-putting-it-together-which-io-functions-should-i-use.html">
            
                <a href="../ch10-system-level-io/10.11-putting-it-together-which-io-functions-should-i-use.html">
            
                    
                    10.11 综合：我该使用哪些 I/O 函数？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.12" data-path="../ch10-system-level-io/10.12-summary.html">
            
                <a href="../ch10-system-level-io/10.12-summary.html">
            
                    
                    10.12 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.1.13" data-path="../ch10-system-level-io/homework.html">
            
                <a href="../ch10-system-level-io/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="./">
            
                <a href="./">
            
                    
                    第 11 章：网络编程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.2.1" data-path="11.1-the-client-server-programming-model.html">
            
                <a href="11.1-the-client-server-programming-model.html">
            
                    
                    11.1 客户端—服务器编程模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.2" data-path="11.2-networks.html">
            
                <a href="11.2-networks.html">
            
                    
                    11.2 网络
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.3" data-path="11.3-the-global-ip-internet.html">
            
                <a href="11.3-the-global-ip-internet.html">
            
                    
                    11.3 全球 IP 因特网
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.4" data-path="11.4-the-sockets-interface.html">
            
                <a href="11.4-the-sockets-interface.html">
            
                    
                    11.4 套接字接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.5" data-path="11.5-web-servers.html">
            
                <a href="11.5-web-servers.html">
            
                    
                    11.5 Web 服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="6.2.6" data-path="11.6-putting-it-together-the-tiny-web-server.html">
            
                <a href="11.6-putting-it-together-the-tiny-web-server.html">
            
                    
                    11.6 综合：TINY Web 服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.7" data-path="11.7-summary.html">
            
                <a href="11.7-summary.html">
            
                    
                    11.7 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2.8" data-path="homework.html">
            
                <a href="homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../ch12-concurrent-programming/">
            
                <a href="../ch12-concurrent-programming/">
            
                    
                    第 12 章：并发编程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="6.3.1" data-path="../ch12-concurrent-programming/12.1-concurrent-programming-with-processes.html">
            
                <a href="../ch12-concurrent-programming/12.1-concurrent-programming-with-processes.html">
            
                    
                    12.1 基于进程的并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.2" data-path="../ch12-concurrent-programming/12.2-concurrent-programming-with-io-multiplexing.html">
            
                <a href="../ch12-concurrent-programming/12.2-concurrent-programming-with-io-multiplexing.html">
            
                    
                    12.2 基于 I/O 多路复用的并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.3" data-path="../ch12-concurrent-programming/12.3-concurrent-programming-with-threads.html">
            
                <a href="../ch12-concurrent-programming/12.3-concurrent-programming-with-threads.html">
            
                    
                    12.3 基于线程的并发编程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.4" data-path="../ch12-concurrent-programming/12.4-shared-variables-in-threaded-programs.html">
            
                <a href="../ch12-concurrent-programming/12.4-shared-variables-in-threaded-programs.html">
            
                    
                    12.4 多线程程序中的共享变量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.5" data-path="../ch12-concurrent-programming/12.5-synchronizing-thread-with-semaphores.html">
            
                <a href="../ch12-concurrent-programming/12.5-synchronizing-thread-with-semaphores.html">
            
                    
                    12.5 用信号量同步线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.6" data-path="../ch12-concurrent-programming/12.6-using-threads-for-parallelism.html">
            
                <a href="../ch12-concurrent-programming/12.6-using-threads-for-parallelism.html">
            
                    
                    12.6 使用线程提高并行性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.7" data-path="../ch12-concurrent-programming/12.7-other-concurrency-issues.html">
            
                <a href="../ch12-concurrent-programming/12.7-other-concurrency-issues.html">
            
                    
                    12.7 其他并发问题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.8" data-path="../ch12-concurrent-programming/12.8-summary.html">
            
                <a href="../ch12-concurrent-programming/12.8-summary.html">
            
                    
                    12.8 小结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3.9" data-path="../ch12-concurrent-programming/homework.html">
            
                <a href="../ch12-concurrent-programming/homework.html">
            
                    
                    家庭作业
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../../appendix-error-handling.html">
            
                <a href="../../appendix-error-handling.html">
            
                    
                    附录 A：错误处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="../../references.html">
            
                <a href="../../references.html">
            
                    
                    参考文献
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">实验</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="../../labs/labs-overview/">
            
                <a href="../../labs/labs-overview/">
            
                    
                    实验总览
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.1.1" data-path="../../labs/labs-overview/common-problems.html">
            
                <a href="../../labs/labs-overview/common-problems.html">
            
                    
                    常见问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="../../labs/data-lab/">
            
                <a href="../../labs/data-lab/">
            
                    
                    实验 1：Data Lab
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.2.1" data-path="../../labs/data-lab/readme-instructor.html">
            
                <a href="../../labs/data-lab/readme-instructor.html">
            
                    
                    README（讲师版）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2.2" data-path="../../labs/data-lab/readme-student.html">
            
                <a href="../../labs/data-lab/readme-student.html">
            
                    
                    README（学生版）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2.3" data-path="../../labs/data-lab/writeup.html">
            
                <a href="../../labs/data-lab/writeup.html">
            
                    
                    Writeup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.3" data-path="../../labs/bomb-lab/">
            
                <a href="../../labs/bomb-lab/">
            
                    
                    实验 2：Bomb Lab
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="8.3.1" data-path="../../labs/bomb-lab/readme-jiang-shi-ban.html">
            
                <a href="../../labs/bomb-lab/readme-jiang-shi-ban.html">
            
                    
                    README（讲师版）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.3.2" data-path="../../labs/bomb-lab/writeup.html">
            
                <a href="../../labs/bomb-lab/writeup.html">
            
                    
                    Writeup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="8.4" data-path="../../labs/attack-lab.html">
            
                <a href="../../labs/attack-lab.html">
            
                    
                    实验 3：Attack Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.5" data-path="../../labs/arch-lab.html">
            
                <a href="../../labs/arch-lab.html">
            
                    
                    实验 4：Architechture Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.6" data-path="../../labs/cache-lab.html">
            
                <a href="../../labs/cache-lab.html">
            
                    
                    实验 5：Cache Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.7" data-path="../../labs/perf-lab.html">
            
                <a href="../../labs/perf-lab.html">
            
                    
                    实验 6：Performance Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.8" data-path="../../labs/shell-lab.html">
            
                <a href="../../labs/shell-lab.html">
            
                    
                    实验 7：Shell Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.9" data-path="../../labs/malloc-lab.html">
            
                <a href="../../labs/malloc-lab.html">
            
                    
                    实验 8：Malloc Lab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.10" data-path="../../labs/proxy-lab.html">
            
                <a href="../../labs/proxy-lab.html">
            
                    
                    实验 9：Proxy Lab
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >11.6 综合：TINY Web 服务器</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="116-综合：tiny-web-服务器">11.6 综合：TINY Web 服务器</h1>
<p>我们通过开发一个虽小但功能齐全的称为 TINY 的 Web 服务器来结束对网络编程的讨论。TINY 是一个有趣的程序。在短短 250 行代码中，它结合了许多我们已经学习到的思想，例如进程控制、Unix I/O、套接字接口和 HTTP。虽然它缺乏一个实际服务器所具备的功能性、健壮性和安全性，但是它足够用来为实际的 Web 浏览器提供静态和动态的内容。我们鼓励你研究它，并且自己实现它。将一个实际的浏览器指向你自己的服务器，看着它显示一个复杂的带有文本和图片的 Web 页面，真是非常令人兴奋（甚至对我们这些作者来说，也是如此！）。</p>
<h2 id="1-tiny-的-main-程序">1. TINY 的 main 程序</h2>
<p>图 11-29 展示了 TINY 的主程序。TINY 是一个迭代服务器，监听在命令行中传递来的端口上的连接请求。在通过调用 open_listenfd 函数打开一个监听套接字以后，TINY 执行典型的无限服务器循环，不断地接受连接请求（第 32 行），执行事务（第 36 行），并关闭连接的它那一端（第 37 行）。</p>
<pre><code class="lang-c"><span class="hljs-comment">/*
* tiny.c - A simple, iterative HTTP/1.0 Web server that uses the
* GET method to serve static and dynamic content
*/</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;csapp.h&quot;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">read_requesthdrs</span><span class="hljs-params">(<span class="hljs-keyword">rio_t</span> *rp)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">parse_uri</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *uri, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> *cgiargs)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serve_static</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">int</span> filesize)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_filetype</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> *filetype)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serve_dynamic</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> *cgiargs)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clienterror</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *cause, <span class="hljs-keyword">char</span> *errnum,
                 <span class="hljs-keyword">char</span> *shortmsg, <span class="hljs-keyword">char</span> *longmsg)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span>
</span>{
    <span class="hljs-keyword">int</span> listenfd, connfd;
    <span class="hljs-keyword">char</span> hostname[MAXLINE], port[MAXLINE];
    <span class="hljs-keyword">socklen_t</span> clientlen;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_storage</span> <span class="hljs-title">clientaddr</span>;</span>

    <span class="hljs-comment">/* Check command-line args */</span>
    <span class="hljs-keyword">if</span> (argc != <span class="hljs-number">2</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;usage: %s &lt;port&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    listenfd = Open_listenfd(argv[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        clientlen = <span class="hljs-keyword">sizeof</span>(clientaddr);
        connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);
        Getnameinfo((SA *) &amp;clientaddr, clientlen, hostname, MAXLINE,
                    port, MAXLINE, <span class="hljs-number">0</span>);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Accepted connection from (%s, %s)\n&quot;</span>, hostname, port);
        doit(connfd);
        Close(connfd);
    }
}
</code></pre>
<blockquote>
<p>图 11-29 TINY Web 服务器</p>
</blockquote>
<h2 id="2-doit-函数">2. doit 函数</h2>
<p>图 11-30 中的 doit 函数处理一个 HTTP 事务。</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doit</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd)</span>
</span>{
    <span class="hljs-keyword">int</span> is_static;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">sbuf</span>;</span>
    <span class="hljs-keyword">char</span> buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];
    <span class="hljs-keyword">char</span> filename[MAXLINE], cgiargs[MAXLINE];
    <span class="hljs-keyword">rio_t</span> rio;

    <span class="hljs-comment">/* Read request line and headers */</span>
    Rio_readinitb(&amp;rio, fd);
    Rio_readlineb(&amp;rio, buf, MAXLINE);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Request headers:\n&quot;</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);
    <span class="hljs-built_in">sscanf</span>(buf, <span class="hljs-string">&quot;%s %s %s&quot;</span>, method, uri, version);
    <span class="hljs-keyword">if</span> (strcasecmp(method, <span class="hljs-string">&quot;GET&quot;</span>)) {
        clienterror(fd, method, <span class="hljs-string">&quot;501&quot;</span>, <span class="hljs-string">&quot;Not implemented&quot;</span>,
                    <span class="hljs-string">&quot;Tiny does not implement this method&quot;</span>);
        <span class="hljs-keyword">return</span>;
    }
    read_requesthdrs(&amp;rio);

    <span class="hljs-comment">/* Parse URI from GET request */</span>
    is_static = parse_uri(uri, filename, cgiargs);
    <span class="hljs-keyword">if</span> (stat(filename, &amp;sbuf) &lt; <span class="hljs-number">0</span>) {
        clienterror(fd, filename, <span class="hljs-string">&quot;404&quot;</span>, <span class="hljs-string">&quot;Not found&quot;</span>,
                    <span class="hljs-string">&quot;Tiny couldn’t find this file&quot;</span>);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (is_static) { <span class="hljs-comment">/* Serve static content */</span>
        <span class="hljs-keyword">if</span> (!(S_ISREG(sbuf.st_mode)) || !(S_IRUSR &amp; sbuf.st_mode)) {
            clienterror(fd, filename, <span class="hljs-string">&quot;403&quot;</span>, <span class="hljs-string">&quot;Forbidden&quot;</span>,
                        <span class="hljs-string">&quot;Tiny couldn’t read the file&quot;</span>);
            <span class="hljs-keyword">return</span>;
        }
        serve_static(fd, filename, sbuf.st_size);
    }
    <span class="hljs-keyword">else</span> { <span class="hljs-comment">/* Serve dynamic content */</span>
        <span class="hljs-keyword">if</span> (!(S_ISREG(sbuf.st_mode)) || !(S_IXUSR &amp; sbuf.st_mode)) {
            clienterror(fd, filename, <span class="hljs-string">&quot;403&quot;</span>, <span class="hljs-string">&quot;Forbidden&quot;</span>,
                        <span class="hljs-string">&quot;Tiny couldn’t run the CGI program&quot;</span>);
            <span class="hljs-keyword">return</span>;
        }
        serve_dynamic(fd, filename, cgiargs);
    }
}
</code></pre>
<blockquote>
<p>图 11-30 TINY doit 处理一个 HTTP 事务</p>
</blockquote>
<p>首先，我们读和解析请求行（第 11 ~ 14 行）。注意，我们使用图 11-8 中的 rio_readlineb 函数读取请求行。</p>
<p>TINY 只支持 GET 方法。如果客户端请求其他方法（比如 POST），我们发送给它一个错误信息，并返回到主程序（第 15 ~ 19 行），主程序随后关闭连接并等待下一个连接请求。否则，我们读并且（像我们将要看到的那样）忽略任何请求报头（第 20 行）。</p>
<p>然后，我们将 URI 解析为一个文件名和一个可能为空的 CGI 参数字符串，并且设置一个标志，表明请求的是静态内容还是动态内容（第 23 行）。如果文件在磁盘上不存在，我们立即发送一个错误信息给客户端并返回。</p>
<p>最后，如果请求的是静态内容，我们就验证该文件是一个普通文件，而我们是有读权限的（第 31 行）。如果是这样，我们就向客户端提供静态内容（第 36 行）。相似地，如果请求的是动态内容，我们就验证该文件是可执行文件（第 39 行），如果是这样，我们就继续，并且提供动态内容（第 44 行）。</p>
<h2 id="3-clienterror-函数">3. clienterror 函数</h2>
<p>TINY 缺乏一个实际服务器的许多错误处理特性。然而，它会检査一些明显的错误，并把它们报告给客户端。图 11-31 中的 clienterror 函数发送一个 HTTP 响应到客户端，在响应行中包含相应的状态码和状态消息，响应主体中包含一个 HTML 文件，向浏览器的用户解释这个错误。</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">clienterror</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *cause, <span class="hljs-keyword">char</span> *errnum,
                 <span class="hljs-keyword">char</span> *shortmsg, <span class="hljs-keyword">char</span> *longmsg)</span>
</span>{
    <span class="hljs-keyword">char</span> buf[MAXLINE], body[MAXBUF];

    <span class="hljs-comment">/* Build the HTTP response body */</span>
    <span class="hljs-built_in">sprintf</span>(body, <span class="hljs-string">&quot;&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;&quot;</span>);
    <span class="hljs-built_in">sprintf</span>(body, <span class="hljs-string">&quot;%s&lt;body bgcolor=&quot;</span><span class="hljs-string">&quot;ffffff&quot;</span><span class="hljs-string">&quot;&gt;\r\n&quot;</span>, body);
    <span class="hljs-built_in">sprintf</span>(body, <span class="hljs-string">&quot;%s%s: %s\r\n&quot;</span>, body, errnum, shortmsg);
    <span class="hljs-built_in">sprintf</span>(body, <span class="hljs-string">&quot;%s&lt;p&gt;%s: %s\r\n&quot;</span>, body, longmsg, cause);
    <span class="hljs-built_in">sprintf</span>(body, <span class="hljs-string">&quot;%s&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n&quot;</span>, body);

    <span class="hljs-comment">/* Print the HTTP response */</span>
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;HTTP/1.0 %s %s\r\n&quot;</span>, errnum, shortmsg);
    Rio_writen(fd, buf, <span class="hljs-built_in">strlen</span>(buf));
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;Content-type: text/html\r\n&quot;</span>);
    Rio_writen(fd, buf, <span class="hljs-built_in">strlen</span>(buf));
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;Content-length: %d\r\n\r\n&quot;</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-built_in">strlen</span>(body));
    Rio_writen(fd, buf, <span class="hljs-built_in">strlen</span>(buf));
    Rio_writen(fd, body, <span class="hljs-built_in">strlen</span>(body));
}
</code></pre>
<blockquote>
<p>图 11-31 TINY clienterror 向客户端发送一个出错消息</p>
</blockquote>
<p>回想一下，HTML 响应应该指明主体中内容的大小和类型。因此，我们选择创建 HTML 内容为一个字符串，这样一来我们可以简单地确定它的大小。还有，请注意我们为所有的输出使用的都是图 10-4 中健壮的 rio_writen 函数。</p>
<h2 id="4-readrequesthdrs-函数">4. read_requesthdrs 函数</h2>
<p>TINY 不使用请求报头中的任何信息。它仅仅调用图 11-32 中的 read_requesthdrs 函数来读取并忽略这些报头。注意，终止请求报头的空文本行是由回车和换行符对组成的，我们在第 6 行中检査它。</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">read_requesthdrs</span><span class="hljs-params">(<span class="hljs-keyword">rio_t</span> *rp)</span>
</span>{
    <span class="hljs-keyword">char</span> buf[MAXLINE];

    Rio_readlineb(rp, buf, MAXLINE);
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">strcmp</span>(buf, <span class="hljs-string">&quot;\r\n&quot;</span>)) {
        Rio_readlineb(rp, buf, MAXLINE);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);
    }
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<blockquote>
<p>图 11-32 TINY read_requesthdrs 读取并忽略请求报头</p>
</blockquote>
<h2 id="5-parseuri-函数">5. parse_uri 函数</h2>
<p>TINY 假设静态内容的主目录就是它的当前目录，而可执行文件的主目录是 <strong>./cgi-bin</strong>。任何包含字符串 <strong>cgi-bin</strong> 的 URI 都会被认为表示的是对动态内容的请求。默认的文件名是 <strong>./home.html</strong>。</p>
<p>图 11-33 中的 parse_uri 函数实现了这些策略。它将 URI 解析为一个文件名和一个可选的 CGI 参数字符串。如果请求的是静态内容（第 5 行），我们将清除 CGI 参数字符串（第 6 行），然后将 URI 转换为一个 Linux 相对路径名，例如 <strong>./index.html</strong>（第 7 ~ 8 行）。如果 URI 是用结尾的（第 9 行），我们将把默认的文件名加在后面（第 10 行）。另一方面，如果请求的是动态内容（第 13 行），我们就会抽取出所有的 CGI 参数（第 14 ~ 20 行），并将 URI 剩下的部分转换为一个 Linux 相对文件名（第 21 ~ 22 行）。</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">parse_uri</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *uri, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> *cgiargs)</span>
</span>{
    <span class="hljs-keyword">char</span> *ptr;

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strstr</span>(uri, <span class="hljs-string">&quot;cgi-bin&quot;</span>)) { <span class="hljs-comment">/* Static content */</span>
        <span class="hljs-built_in">strcpy</span>(cgiargs, <span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-built_in">strcpy</span>(filename, <span class="hljs-string">&quot;.&quot;</span>);
        <span class="hljs-built_in">strcat</span>(filename, uri);
        <span class="hljs-keyword">if</span> (uri[<span class="hljs-built_in">strlen</span>(uri) - <span class="hljs-number">1</span>] == ’ / ’)
            <span class="hljs-built_in">strcat</span>(filename, <span class="hljs-string">&quot;home.html&quot;</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">else</span> { <span class="hljs-comment">/* Dynamic content */</span>
        ptr = index(uri, ’ ? ’);
        <span class="hljs-keyword">if</span> (ptr) {
            <span class="hljs-built_in">strcpy</span>(cgiargs, ptr + <span class="hljs-number">1</span>);
            *ptr = ’\<span class="hljs-number">0</span>’;
        }
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">strcpy</span>(cgiargs, <span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-built_in">strcpy</span>(filename, <span class="hljs-string">&quot;.&quot;</span>);
        <span class="hljs-built_in">strcat</span>(filename, uri);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
}
</code></pre>
<blockquote>
<p>图 11-33 TINY parse_uri 解析一个 HTTP URI</p>
</blockquote>
<h2 id="6-servestatic-函数">6. serve_static 函数</h2>
<p>TINY 提供五种常见类型的静态内容：HTML 文件、无格式的文本文件，以及编码为 GIF、PNG 和 JPG 格式的图片。</p>
<p>图 11-34 中的 serve_static 函数发送一个 HTTP 响应，其主体包含一个本地文件的内容。</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serve_static</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">int</span> filesize)</span>
</span>{
    <span class="hljs-keyword">int</span> srcfd;
    <span class="hljs-keyword">char</span> *srcp, filetype[MAXLINE], buf[MAXBUF];

    <span class="hljs-comment">/* Send response headers to client */</span>
    get_filetype(filename, filetype);
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>);
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;%sServer: Tiny Web Server\r\n&quot;</span>, buf);
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;%sConnection: close\r\n&quot;</span>, buf);
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;%sContent-length: %d\r\n&quot;</span>, buf, filesize);
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;%sContent-type: %s\r\n\r\n&quot;</span>, buf, filetype);
    Rio_writen(fd, buf, <span class="hljs-built_in">strlen</span>(buf));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Response headers:\n&quot;</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, buf);

    <span class="hljs-comment">/* Send response body to client */</span>
    srcfd = Open(filename, O_RDONLY, <span class="hljs-number">0</span>);
    srcp = Mmap(<span class="hljs-number">0</span>, filesize, PROT_READ, MAP_PRIVATE, srcfd, <span class="hljs-number">0</span>);
    Close(srcfd);
    Rio_writen(fd, srcp, filesize);
    Munmap(srcp, filesize);
}

<span class="hljs-comment">/*
* get_filetype - Derive file type from filename
*/</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">get_filetype</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> *filetype)</span>
</span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(filename, <span class="hljs-string">&quot;.html&quot;</span>))
        <span class="hljs-built_in">strcpy</span>(filetype, <span class="hljs-string">&quot;text/html&quot;</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(filename, <span class="hljs-string">&quot;.gif&quot;</span>))
        <span class="hljs-built_in">strcpy</span>(filetype, <span class="hljs-string">&quot;image/gif&quot;</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(filename, <span class="hljs-string">&quot;.png&quot;</span>))
        <span class="hljs-built_in">strcpy</span>(filetype, <span class="hljs-string">&quot;image/png&quot;</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(filename, <span class="hljs-string">&quot;.jpg&quot;</span>))
        <span class="hljs-built_in">strcpy</span>(filetype, <span class="hljs-string">&quot;image/jpeg&quot;</span>);
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">strcpy</span>(filetype, <span class="hljs-string">&quot;text/plain&quot;</span>);
}
</code></pre>
<blockquote>
<p>图 11-34 TINY serve_static 为客户端提供静态内容</p>
</blockquote>
<p>首先，我们通过检査文件名的后缀来判断文件类型（第 7 行），并且发送响应行和响应报头给客户端（第 8 ~ 13 行）。注意用一个空行终止报头。</p>
<p>接着，我们将被请求文件的内容复制到已连接描述符 fd 来发送响应主体。这里的代码是比较微妙的，需要仔细研究。第 18 行以读方式打开 filename，并获得它的描述符。在第 19 行，Linux mmap 函数将被请求文件映射到一个虚拟内存空间。回想我们在第 9.8 节中对 remap 的讨论，调用 mmap 将文件 srcfd 的前 filesize 个字节映射到一个从地址 srcp 开始的私有只读虚拟内存区域。</p>
<p>一旦将文件映射到内存，就不再需要它的描述符了，所以我们关闭这个文件（第 20 行）。执行这项任务失败将导致潜在的致命的内存泄漏。第 21 行执行的是到客户端的实际文件传送。rio_writen 函数复制从 srcp 位置开始的 filesize 个字节（它们当然已经被映射到了所请求的文件）到客户端的已连接描述符。最后，第 22 行释放了映射的虚拟内存区域。这对于避免潜在的致命的内存泄漏是很重要的。</p>
<h2 id="7-servedynamic-函数">7. serve_dynamic 函数</h2>
<p>TINY 通过派生一个子进程并在子进程的上下文中运行一个 CGI 程序，来提供各种类型的动态内容。</p>
<p>图 11-35 中的 serve_dynamic 函数一开始就向客户端发送一个表明成功的响应行，同时还包括带有信息的 Server 报头。CGI 程序负责发送响应的剩余部分。注意，这并不像我们可能希望的那样健壮，因为它没有考虑到 CGI 程序会遇到某些错误的可能性。</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serve_dynamic</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">char</span> *cgiargs)</span>
</span>{
    <span class="hljs-keyword">char</span> buf[MAXLINE], *emptylist[] = { <span class="hljs-literal">NULL</span> };

    <span class="hljs-comment">/* Return first part of HTTP response */</span>
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>);
    Rio_writen(fd, buf, <span class="hljs-built_in">strlen</span>(buf));
    <span class="hljs-built_in">sprintf</span>(buf, <span class="hljs-string">&quot;Server: Tiny Web Server\r\n&quot;</span>);
    Rio_writen(fd, buf, <span class="hljs-built_in">strlen</span>(buf));

    <span class="hljs-keyword">if</span> (Fork() == <span class="hljs-number">0</span>) { <span class="hljs-comment">/* Child */</span>
        <span class="hljs-comment">/* Real server would set all CGI vars here */</span>
        setenv(<span class="hljs-string">&quot;QUERY_STRING&quot;</span>, cgiargs, <span class="hljs-number">1</span>);
        Dup2(fd, STDOUT_FILENO); <span class="hljs-comment">/* Redirect stdout to client */</span>
        Execve(filename, emptylist, environ); <span class="hljs-comment">/* Run CGI program */</span>
    }
    Wait(<span class="hljs-literal">NULL</span>); <span class="hljs-comment">/* Parent waits for and reaps child */</span>
}
</code></pre>
<blockquote>
<p>图 11-35 TINY serve_dynamic 为客户端提供动态内容</p>
</blockquote>
<p>在发送了响应的第一部分后，我们会派生一个新的子进程（第 11 行）。子进程用来自请求 URI 的 CGI 参数初始化 QUERY_STRING 环境变量（第 13 行）。注意，一个真正的服务器还会在此处设置其他的 CGI 环境变量。为了简短，我们省略了这一步。</p>
<p>接下来，子进程重定向它的标准输出到已连接文件描述符（第 14 行），然后加载并运行 CGI 程序（第 15 行）。因为 CGI 程序运行在子进程的上下文中，它能够访问所有在调用 ex¬ecve 函数之前就存在的打开文件和环境变量。因此，CGI 程序写到标准输出上的任何东西都将直接送到客户端进程，不会受到任何来自父进程的干涉。其间，父进程阻塞在对 wait 的调用中，等待当子进程终止的时候，回收操作系统分配给子进程的资源（第 17 行）。</p>
<p><div class="alert alert-info hints-alert"><div class="hints-icon"><i class="fa fa-info-circle"></i></div><div class="hints-container"><h3 id="旁注---处理过早关闭的连接">旁注 - 处理过早关闭的连接</h3>
<p>尽管一个 Web 服务器的基本功能非常简单，但是我们不想给你一个假象，以为编写一个实际的 Web 服务器是非常简单的。构造一个长时间运行而不崩溃的健壮的 Web 服务器是一件困难的任务，比起在这里我们已经学习了的内容，它要求对 Linux 系统编程有更加深入的理解。例如，如果一个服务器写一个已经被客户端关闭了的连接（比如，因为你在浏览器上单击了 “Stop” 按钮），那么第一次这样的写会正常返回，但是第二次写就会引起发送 SIGPIPE 信号，这个信号的默认行为就是终止这个进程。如果捕获或者忽略 SIGPIPE 信号，那么第二次写操作会返回值 -1，并将 errno 设置为 EPIPE。strerr 和 perror 函数将 EPIPE 错误报告为 “Broken pipe”，这是一个迷惑了很多人的不太直观的信息。总的来说，一个健壮的服务器必须捕获这些 SIGPIPE 信号，并且检查 write 函数调用是否有 EPIPE 错误。</p>
</div></div></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="11.5-web-servers.html" class="navigation navigation-prev " aria-label="Previous page: 11.5 Web 服务器">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="11.7-summary.html" class="navigation navigation-next " aria-label="Next page: 11.7 小结">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"11.6 综合：TINY Web 服务器","level":"6.2.6","depth":2,"next":{"title":"11.7 小结","level":"6.2.7","depth":2,"path":"part3/ch11-network-programming/11.7-summary.md","ref":"part3/ch11-network-programming/11.7-summary.md","articles":[]},"previous":{"title":"11.5 Web 服务器","level":"6.2.5","depth":2,"path":"part3/ch11-network-programming/11.5-web-servers.md","ref":"part3/ch11-network-programming/11.5-web-servers.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["hints","page-ref","mathjax-pro"],"pluginsConfig":{"hints":{"info":"fa fa-info-circle","tip":"fa fa-mortar-board","danger":"fa fa-exclamation-circle","working":"fa fa-wrench"},"page-ref":{},"mathjax-pro":{"forceSVG":false,"version":"2.7.7"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"part3/ch11-network-programming/11.6-putting-it-together-the-tiny-web-server.md","mtime":"2022-04-29T14:04:53.399Z","type":"markdown"},"gitbook":{"version":"3.7.1","time":"2022-04-30T05:14:56.515Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-mathjax-pro/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

